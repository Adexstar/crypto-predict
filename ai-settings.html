<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Quant Settings - Crypto Trading</title>
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header class="header" id="app-header"></header>
  <main class="container">
    <div class="back-link"><a href="index.html">‚Üê Back to Dashboard</a></div>
    
    <div class="qa-indicator" style="margin-bottom:20px">ü§ñ AI Quant Settings</div>
    
    <div class="card">
      <h2 class="card-title">AI Quant Trading Bot</h2>
      <p class="card-subtitle">Configure your automated trading assistant</p>
      
      <div style="margin-top:30px">
        <!-- Current Status & Balances -->
        <div id="ai-status-card" style="background:#f5f5f5;padding:20px;border-radius:8px;margin-bottom:30px">
          <div class="kv">
            <div>
              <div style="font-size:14px;color:#666;margin-bottom:5px">AI Bot Status</div>
              <div id="bot-status" style="font-size:18px;font-weight:700;color:#0b9d58">‚óè ACTIVE</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:14px;color:#666;margin-bottom:5px">Subscription Amount</div>
              <div id="sub-amount" style="font-size:18px;font-weight:700">$0.00</div>
            </div>
          </div>
          
          <!-- Balance Display -->
          <div style="margin-top:15px;border-top:1px solid #ddd;padding-top:15px">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
              <div>
                <div style="font-size:12px;color:#666;margin-bottom:5px">Testing Balance</div>
                <div style="font-size:16px;font-weight:600;color:#f59e0b">$<span id="testing-balance">0.00</span></div>
                <div style="font-size:11px;color:#999;margin-top:3px">10% return (max $500, 2x/day)</div>
              </div>
              <div>
                <div style="font-size:12px;color:#666;margin-bottom:5px">Deposited Balance</div>
                <div style="font-size:16px;font-weight:600;color:#0b9d58">$<span id="deposited-balance">0.00</span></div>
                <div style="font-size:11px;color:#999;margin-top:3px">150% return (max $10k, 1x/day)</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Trading Strategy -->
        <div class="form-group">
          <label>Select Trading Strategy</label>
          <select id="strategy" class="input">
            <option value="conservative">Conservative (Low Risk)</option>
            <option value="moderate" selected>Moderate (Balanced)</option>
            <option value="aggressive">Aggressive (High Risk)</option>
          </select>
          <div class="small" style="margin-top:8px;color:#666">
            Choose your risk tolerance level for automated trading
          </div>
        </div>

        <!-- Risk Management -->
        <div class="form-group">
          <label>Max Position Size (%)</label>
          <input type="range" id="position-size" class="input" min="1" max="20" value="5" oninput="updatePositionDisplay(this.value)">
          <div class="small" style="margin-top:8px;color:#666">
            Current: <span id="position-display" style="font-weight:600">5%</span> of account balance per trade
          </div>
        </div>

        <!-- Stop Loss -->
        <div class="form-group">
          <label>Stop Loss (%)</label>
          <input type="range" id="stop-loss" class="input" min="1" max="10" value="3" oninput="updateStopLossDisplay(this.value)">
          <div class="small" style="margin-top:8px;color:#666">
            Current: <span id="stoploss-display" style="font-weight:600">3%</span> maximum loss per trade
          </div>
        </div>

        <!-- Take Profit -->
        <div class="form-group">
          <label>Take Profit Target (%)</label>
          <input type="range" id="take-profit" class="input" min="2" max="20" value="6" oninput="updateTakeProfitDisplay(this.value)">
          <div class="small" style="margin-top:8px;color:#666">
            Current: <span id="takeprofit-display" style="font-weight:600">6%</span> profit target per trade
          </div>
        </div>

        <div style="margin-top:30px" class="divider"></div>

        <!-- Subscription Section -->
        <h3 style="margin-top:30px;margin-bottom:15px">AI Bot Subscription</h3>
        
        <!-- Balance Type Info -->
        <div style="background:#e8f4f8;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #0b9d58">
          <div style="font-weight:600;margin-bottom:10px">üí° How to Subscribe:</div>
          <div style="font-size:13px;line-height:1.6;color:#333">
            <div style="margin-bottom:8px"><strong>Testing Balance ($100-$500):</strong> Earn 10% profit. Limited to 2 subscriptions per day. Use this to test strategies.</div>
            <div><strong>Deposited Balance ($100-$10,000):</strong> Earn 150% profit. Limited to 1 subscription per day. Make a deposit and have admin approve it to use this.</div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Subscription Amount (USD)</label>
          <input type="number" id="ai-sub-amt" class="input" placeholder="Testing: $100-$500 OR Deposited: $100-$10,000" min="100" max="10000">
          <div class="small" style="margin-top:8px;color:#f59e0b">
            üí° System will automatically use Testing Balance first (if available), then Deposited Balance
          </div>
        </div>

        <!-- Features List -->
        <div style="background:#f5f5f5;padding:20px;border-radius:8px;margin-top:20px;margin-bottom:20px">
          <div style="font-weight:700;margin-bottom:15px">AI Bot Features:</div>
          <div style="display:grid;gap:10px">
            <div class="small">‚úÖ 24/7 Automated Trading</div>
            <div class="small">‚úÖ Machine Learning Price Predictions</div>
            <div class="small">‚úÖ Real-time Market Analysis</div>
            <div class="small">‚úÖ Risk Management Controls</div>
            <div class="small">‚úÖ Multi-asset Portfolio Optimization</div>
            <div class="small">‚úÖ Separate returns: 10% (testing) / 150% (deposited)</div>
          </div>
        </div>

        <button class="cta cta-full" id="subscribe-btn" onclick="subscribeAIBot()">ACTIVATE AI BOT SUBSCRIPTION</button>
        <div id="ai-msg" class="small" style="margin-top:15px;text-align:center"></div>

        <div style="margin-top:30px" class="divider"></div>

        <!-- Performance History -->
        <h3 style="margin-top:30px;margin-bottom:15px">AI Bot Performance</h3>
        <div id="performance-history">
          <p class="small" style="color:#666">No performance data yet. Subscribe to start tracking.</p>
        </div>
      </div>
    </div>
  </main>

  <script src="js/api-config.js"></script>
  <script type="module">
    import { getRealUser } from './js/user-context.js';

    let currentUser = null;

    async function loadUser() {
      currentUser = await getRealUser();
      if (!currentUser) {
        window.location.href = '/login.html';
        return;
      }
      renderHeader();
      loadAISettings();
    }

    function renderHeader() {
      if (!currentUser) return;
      document.getElementById('app-header').innerHTML = `
        <div class="brand"><div class="logo">FX</div><div>
          <div style="font-weight:800">AI Quant Settings</div>
          <div class="small">User: ${currentUser.name}</div>
        </div></div>
        <div class="nav">
          <span class="badge-sim">AI MODE</span>
        </div>`;
    }

    function loadAISettings() {
      if (!currentUser) return;
      
      // Display balances
      const testingBal = currentUser.testingBalance || 0;
      const depositedBal = currentUser.balance || 0;
      
      document.getElementById('testing-balance').textContent = testingBal.toLocaleString(undefined, {minimumFractionDigits:2});
      document.getElementById('deposited-balance').textContent = depositedBal.toLocaleString(undefined, {minimumFractionDigits:2});
      
      // Check if user has active AI subscription by looking at history
      const aiSubHistory = (currentUser.history || []).find(h => h.action === 'ai.subscription');
      
      if (aiSubHistory) {
        document.getElementById('bot-status').innerHTML = '‚óè ACTIVE';
        document.getElementById('bot-status').style.color = '#0b9d58';
        
        // Parse the meta to get the subscription amount
        let subAmount = 0;
        if (aiSubHistory.meta) {
          try {
            const meta = typeof aiSubHistory.meta === 'string' ? JSON.parse(aiSubHistory.meta) : aiSubHistory.meta;
            subAmount = meta.subscriptionAmount || 0;
          } catch (e) {
            subAmount = 0;
          }
        }
        document.getElementById('sub-amount').textContent = '$' + subAmount.toLocaleString();
      } else {
        document.getElementById('bot-status').innerHTML = '‚óã INACTIVE';
        document.getElementById('bot-status').style.color = '#d03030';
        document.getElementById('sub-amount').textContent = '$0.00';
      }

      // Load saved settings
      if (currentUser.aiSettings) {
        document.getElementById('strategy').value = currentUser.aiSettings.strategy || 'moderate';
        document.getElementById('position-size').value = currentUser.aiSettings.positionSize || 5;
        document.getElementById('stop-loss').value = currentUser.aiSettings.stopLoss || 3;
        document.getElementById('take-profit').value = currentUser.aiSettings.takeProfit || 6;
        
        updatePositionDisplay(currentUser.aiSettings.positionSize || 5);
        updateStopLossDisplay(currentUser.aiSettings.stopLoss || 3);
        updateTakeProfitDisplay(currentUser.aiSettings.takeProfit || 6);
      }

      renderPerformanceHistory();
    }

    function renderPerformanceHistory() {
      if (!currentUser) return;
      const container = document.getElementById('performance-history');
      
      // Filter history for AI-related actions
      const aiHistory = (currentUser.history || []).filter(h => h.action && h.action.startsWith('ai.'));
      
      if (aiHistory.length === 0) {
        container.innerHTML = '<p class="small" style="color:#666">No performance data yet. Subscribe to start tracking.</p>';
        return;
      }

      container.innerHTML = `
        <div style="display:grid;gap:10px">
          ${aiHistory.slice(0, 10).map(h => {
            const meta = typeof h.meta === 'string' ? JSON.parse(h.meta) : h.meta;
            const amount = meta?.profit || meta?.amount || meta?.subscriptionAmount || 0;
            const subType = meta?.subscriptionType || 'unknown';
            const fundLabel = subType === 'testing' ? '(Testing - 10%)' : '(Deposited - 150%)';
            const actionLabel = h.action === 'ai.subscription' ? `Subscription ${fundLabel}` : 
                               h.action === 'ai.profit' ? 'Profit Earned' : h.action.toUpperCase();
            return `
              <div class="card" style="padding:12px;border-left:4px solid #f0ad4e;">
                <div class="kv">
                  <div>
                    <div class="small" style="color:#666">${new Date(h.createdAt || h.ts).toLocaleString()}</div>
                    <div style="font-weight:600">${actionLabel}</div>
                  </div>
                  <div style="text-align:right">
                    <div style="font-size:16px;font-weight:700;color:#0b9d58">
                      +$${amount.toFixed(2)}
                    </div>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    window.updatePositionDisplay = function(value) {
      document.getElementById('position-display').textContent = value + '%';
    };

    window.updateStopLossDisplay = function(value) {
      document.getElementById('stoploss-display').textContent = value + '%';
    };

    window.updateTakeProfitDisplay = function(value) {
      document.getElementById('takeprofit-display').textContent = value + '%';
    };

    window.subscribeAIBot = async function() {
      const amt = Number(document.getElementById('ai-sub-amt').value || 0);
      if (!currentUser) return;
      const msg = document.getElementById('ai-msg');
      const btn = document.getElementById('subscribe-btn');

      const testingBal = currentUser.testingBalance || 0;
      const depositedBal = currentUser.balance || 0;

      // Validate amount and determine subscription type
      let subscriptionType = null;
      let returnRate = null;
      let maxDaily = null;
      
      // Check if amount fits testing balance criteria ($100-$500)
      if (amt >= 100 && amt <= 500 && testingBal >= amt) {
        subscriptionType = 'testing';
        returnRate = 0.10; // 10%
        maxDaily = 2;
      } 
      // Check if amount fits real deposit criteria ($100-$10,000)
      else if (amt >= 100 && amt <= 10000 && depositedBal >= amt) {
        subscriptionType = 'deposited';
        returnRate = 1.50; // 150%
        maxDaily = 1;
      }
      
      // Validate and show appropriate error
      if (!subscriptionType) {
        if (amt < 100 || amt > 10000) {
          msg.innerHTML = '<span style="color:#d03030">‚ùå Invalid amount. Testing: $100-$500 (2x daily). Deposited: $100-$10,000 (1x daily).</span>';
        } else if (testingBal < amt && depositedBal < amt) {
          msg.innerHTML = '<span style="color:#d03030">‚ùå Insufficient balance. Testing Balance: $' + testingBal.toFixed(2) + ', Deposited Balance: $' + depositedBal.toFixed(2) + '</span>';
        } else {
          msg.innerHTML = '<span style="color:#d03030">‚ùå Invalid subscription amount for available balances.</span>';
        }
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Processing...';
      msg.innerHTML = '<span style="color:#f0ad4e">‚è≥ Activating AI Bot...</span>';

      try {
        const response = await fetch(`${API_CONFIG.API_URL}/ai/subscribe`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          },
          body: JSON.stringify({
            amount: amt,
            strategy: document.getElementById('strategy').value,
            positionSize: Number(document.getElementById('position-size').value),
            stopLoss: Number(document.getElementById('stop-loss').value),
            takeProfit: Number(document.getElementById('take-profit').value)
          })
        });

        if (!response.ok) {
          let errorMsg = 'Failed to subscribe';
          try {
            const data = await response.json();
            errorMsg = data.error || errorMsg;
          } catch (e) {
            if (response.status === 404) {
              errorMsg = 'AI subscription service not yet deployed. Please wait a moment and try again.';
            } else if (response.status === 401) {
              errorMsg = 'Please login first';
            }
          }
          throw new Error(errorMsg);
        }

        const data = await response.json();
        const sub = data.subscription;

        // Update local user data
        currentUser = data.user;

        const fundType = sub.subscriptionType === 'testing' 
          ? 'Testing Funds (10% return)' 
          : 'Deposited Funds (150% return)';

        msg.innerHTML = `<span style="color:#0b9d58">‚úÖ AI Bot activated! (${fundType})<br>Subscription: $${sub.amount.toFixed(2)}<br>Profit earned: $${sub.profit.toFixed(2)}</span>`;
        
        document.getElementById('ai-sub-amt').value = '';
        loadAISettings();
        btn.disabled = false;
        btn.textContent = 'ACTIVATE AI BOT SUBSCRIPTION';
      } catch (error) {
        console.error('AI subscription error:', error);
        msg.innerHTML = `<span style="color:#d03030">‚ùå ${error.message}</span>`;
        btn.disabled = false;
        btn.textContent = 'ACTIVATE AI BOT SUBSCRIPTION';
      }
    };

    loadUser();
  </script>
</body>
</html>
