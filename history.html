<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>History Trading</title>
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header class="header" id="app-header"></header>
  <main class="container">
    <div class="back-link"><a href="index.html">‚Üê Back to Dashboard</a></div>
    
    <div class="qa-indicator" style="margin-bottom:20px">üî¨ Transaction History Access</div>
    
    <div class="card">
      <h2 class="card-title">Transaction History</h2>
      <p class="card-subtitle">All account activity</p>
      
      <div style="margin-top:20px">
        <div style="margin-bottom:15px">
          <label>Filter by Type:</label>
          <select id="filter-type" class="input" style="margin-top:5px">
            <option value="">All Transactions</option>
            <option value="deposit">Deposits</option>
            <option value="withdraw">Withdrawals</option>
            <option value="transfer">Transfers</option>
            <option value="subscribe">Subscriptions</option>
            <option value="profit">Profit</option>
          </select>
        </div>

        <div id="history-list" style="display:flex;flex-direction:column;gap:10px"></div>

        <div style="margin-top:40px;padding-top:40px;border-top:1px solid #333">
          <h3 style="color:#f0ad4e;margin-bottom:15px">Withdrawal Requests</h3>
          <div id="withdrawal-requests" style="display:flex;flex-direction:column;gap:10px"></div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/lightweight-charts@3.10.0/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="js/api-config.js"></script>
  <script type="module">
    import { getRealUser } from './js/user-context.js';

    let currentUser = null;
    let allHistory = [];

    async function loadUser() {
      currentUser = await getRealUser();
      if (!currentUser) {
        window.location.href = 'login.html';
        return;
      }
      renderHeader();
      await fetchHistory();
    }

    async function fetchHistory() {
      try {
        const response = await fetch(`${API_CONFIG.API_URL}/user/history`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          }
        });

        if (!response.ok) throw new Error('Failed to fetch history');
        
        const data = await response.json();
        allHistory = data.history || [];
        renderHistory('');
        renderWithdrawalRequests();
      } catch (error) {
        console.error('Error fetching history:', error);
        document.getElementById('history-list').innerHTML = '<p class="small" style="color:#d03030">‚ùå Failed to load history</p>';
      }
    }

    async function renderWithdrawalRequests() {
      try {
        const response = await fetch(`${API_CONFIG.API_URL}/withdrawals`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          }
        });

        if (!response.ok) throw new Error('Failed to fetch withdrawals');
        
        const data = await response.json();
        const withdrawals = data.withdrawals || [];
        const container = document.getElementById('withdrawal-requests');

        if (withdrawals.length === 0) {
          container.innerHTML = '<p class="small">No withdrawal requests yet</p>';
          return;
        }

        container.innerHTML = withdrawals.map((w, idx) => {
          const statusColor = w.status === 'PENDING' ? '#f0ad4e' : (w.status === 'APPROVED' ? '#0b9d58' : '#d03030');
          const time = new Date(w.createdAt).toLocaleString();
          return `
            <div class="card" style="padding:12px;background:${idx % 2 === 0 ? '#fff' : '#f8f8f8'}">
              <div class="kv">
                <div>
                  <strong>Withdrawal Request</strong>
                  <div class="small">Amount: $${w.amount.toFixed(2)}</div>
                  <div class="small">Network: ${w.network || 'N/A'}</div>
                  <div class="small">Method: ${w.method || 'CRYPTO'}</div>
                  <div class="small">Wallet: ${w.walletAddress || 'N/A'}</div>
                </div>
                <div style="text-align:right">
                  <div class="small" style="color:${statusColor};font-weight:600">${w.status}</div>
                  <div class="small">${time}</div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error fetching withdrawal requests:', error);
        document.getElementById('withdrawal-requests').innerHTML = '<p class="small" style="color:#d03030">‚ùå Failed to load withdrawal requests</p>';
      }
    }

    function renderHeader() {
      if (!currentUser) return;
      document.getElementById('app-header').innerHTML = `
        <div class="brand"><div class="logo">FX</div><div>
          <div style="font-weight:800">Transaction History</div>
          <div class="small">User: ${currentUser.name}</div>
        </div></div>
        <div class="nav">
          <span class="badge-sim">HISTORY</span>
        </div>`;
    }

    function getActionLabel(action) {
      if (action.includes('deposit')) return 'Deposit';
      if (action.includes('withdraw')) return 'Withdrawal';
      if (action.includes('transfer')) return 'Transfer';
      if (action.includes('ai.subscription')) return 'AI Subscription';
      if (action.includes('ai.profit')) return 'AI Profit';
      return action.replace(/\./g, ' ').toUpperCase();
    }

    function renderHistory(filter = '') {
      const list = document.getElementById('history-list');
      
      let filtered = allHistory;
      if (filter) {
        // Map filter values to action patterns
        const filterMap = {
          'deposit': 'deposit',
          'withdraw': 'withdraw',
          'transfer': 'transfer',
          'subscribe': 'ai.subscription',
          'profit': 'ai.profit'
        };
        const pattern = filterMap[filter];
        if (pattern) {
          filtered = allHistory.filter(h => h.action && h.action.includes(pattern));
        }
      }

      if (filtered.length === 0) {
        list.innerHTML = '<p class="small">No transactions</p>';
        return;
      }

      list.innerHTML = filtered.map((h, idx) => {
        const message = h.message || getActionLabel(h.action);
        const time = new Date(h.createdAt).toLocaleString();
        return `
          <div class="card" style="padding:12px;background:${idx % 2 === 0 ? '#fff' : '#f8f8f8'}">
            <div class="kv">
              <div>
                <strong>${message}</strong>
                <div class="small">${h.action}</div>
              </div>
              <div style="text-align:right">
                <div class="small">${time}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    document.getElementById('filter-type').addEventListener('change', (e) => {
      renderHistory(e.target.value);
    });

    loadUser();
    
    // Check authentication
    (async () => {
      try {
        await AuthAPI.verify();
      } catch (error) {
        console.warn('Not authenticated, redirecting to login');
        setTimeout(() => window.location.href = 'login.html', 2000);
      }
    })();
  </script>
</body>
</html>
