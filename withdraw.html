<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Withdraw Trading</title>
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header class="header" id="app-header"></header>
  <main class="container">
    <div class="back-link"><a href="index.html">‚Üê Back to Dashboard</a></div>
    
    <div class="qa-indicator" style="margin-bottom:20px">üî¨ ACCOUNT Withdrawal</div>
    
    <div class="card">
      <h2 class="card-title">Remove Funds from Account</h2>
      <p class="card-subtitle">Balance Adjustment</p>
      
      <div style="margin-top:20px">
        <div class="info-box">
          <strong>Current Balance: </strong><span id="balance-display">$0.00</span>
        </div>

        <div class="form-group" style="margin-top:20px">
          <label>Select Network</label>
          <select id="withdraw-network" class="input">
            <option value="ethereum">Ethereum (ERC20)</option>
            <option value="bsc">Binance Smart Chain (BEP20)</option>
            <option value="polygon">Polygon (MATIC)</option>
            <option value="tron">Tron (TRC20)</option>
          </select>
        </div>

        <div class="form-group">
          <label>Wallet Address</label>
          <input type="text" id="wallet-addr" class="input" placeholder="Your wallet address">
        </div>

        <div class="form-group">
          <label>Withdrawal Amount</label>
          <input type="number" id="withdraw-amt" class="input" placeholder="Enter amount">
          <div class="small" style="margin-top:5px">Minimum: $100</div>
        </div>

        <div class="form-group" id="fee-info" style="background:#7c3232;padding:10px;border-radius:8px;display:none">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px">
            <span>Withdrawal Amount:</span>
            <span id="fee-amount">$0.00</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px">
            <span>Network Fee (1%):</span>
            <span id="fee-network">$0.00</span>
          </div>
          <div style="display:flex;justify-content:space-between;border-top:1px solid #dddddd;padding-top:8px;font-weight:700">
            <span>You Will Receive:</span>
            <span id="fee-receive">$0.00</span>
          </div>
        </div>

        <button class="cta cta-full" id="withdraw-btn" style="margin-top:20px">Request Withdrawal</button>
        <div id="withdraw-msg" class="small" style="margin-top:10px;text-align:center"></div>

        <div style="margin-top:30px" class="divider"></div>

        <h3 style="margin-top:20px">Withdrawal Requests</h3>
        <div id="withdrawals-list" style="margin-top:15px"></div>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/lightweight-charts@3.10.0/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="js/api-config.js"></script>
  <script type="module">
    import { getRealUser } from './js/user-context.js';
    let currentUser = null;

    async function ensureUser() {
      currentUser = await getRealUser();
      if (!currentUser) window.location.href = 'login.html';
    }

    function renderHeader() {
      if (!currentUser) return;
      document.getElementById('app-header').innerHTML = `
        <div class="brand"><div class="logo">FX</div><div>
          <div style="font-weight:800">Withdraw</div>
          <div class="small">User: ${currentUser.name}</div>
        </div></div>
        <div class="nav">
          <span class="badge-sim">ACCESS WITHDRAWAL</span>
        </div>`;
    }

    function renderPage() {
      if (!currentUser) return;
      document.getElementById('balance-display').innerText = `$${currentUser.balance.toLocaleString(undefined, {minimumFractionDigits:2})}`;
      
      if (currentUser.frozen) {
        document.getElementById('withdraw-msg').innerHTML = '‚ö†Ô∏è <strong>Account is FROZEN.</strong> Withdrawals blocked. Contact support.';
        document.getElementById('withdraw-msg').style.color = '#d03030';
        document.getElementById('withdraw-btn').disabled = true;
      }

      // Render pending withdrawals
      const userWithdrawals = [];  // No local state, would need backend
      const list = document.getElementById('withdrawals-list');
      if (userWithdrawals.length === 0) {
        list.innerHTML = '<p class="small">No pending requests</p>';
      } else {
        list.innerHTML = userWithdrawals.map(w => `
          <div class="card" style="margin-bottom:10px;padding:10px;background:#fff8f0">
            <div class="kv">
              <div><strong>$${w.amount.toLocaleString()}</strong></div>
              <div class="small" style="color:#${w.status === 'approved' ? '0b9d58' : w.status === 'rejected' ? 'd03030' : 'f59e0b'}">${w.status.toUpperCase()}</div>
            </div>
            <div class="small" style="margin-top:5px">${new Date(w.ts).toLocaleString()}</div>
          </div>
        `).join('');
      }
    }

    document.getElementById('withdraw-amt').addEventListener('input', (e) => {
      const amt = Number(e.target.value || 0);
      if (amt > 0) {
        const fee = +(amt * 0.01).toFixed(2);
        const receive = +(amt - fee).toFixed(2);
        
        document.getElementById('fee-info').style.display = 'block';
        document.getElementById('fee-amount').innerText = `$${amt.toLocaleString()}`;
        document.getElementById('fee-network').innerText = `$${fee.toLocaleString()}`;
        document.getElementById('fee-receive').innerText = `$${receive.toLocaleString()}`;
      } else {
        document.getElementById('fee-info').style.display = 'none';
      }
    });

    document.getElementById('withdraw-btn').addEventListener('click', () => {
      const amt = Number(document.getElementById('withdraw-amt').value || 0);
      const addr = document.getElementById('wallet-addr').value;
      
      if (!currentUser) {
        document.getElementById('withdraw-msg').innerText = '‚ùå Not authenticated';
        return;
      }
      
      if (currentUser.frozen) {
        document.getElementById('withdraw-msg').innerHTML = '‚ö†Ô∏è Account frozen. Cannot withdraw.';
        document.getElementById('withdraw-msg').style.color = '#d03030';
        return;
      }

      if (!addr) {
        document.getElementById('withdraw-msg').innerText = '‚ùå Enter a wallet address';
        document.getElementById('withdraw-msg').style.color = '#d03030';
        return;
      }

      if (amt < 100) {
        document.getElementById('withdraw-msg').innerText = '‚ùå Minimum withdrawal is $100';
        document.getElementById('withdraw-msg').style.color = '#d03030';
        return;
      }

      if (amt > currentUser.balance) {
        document.getElementById('withdraw-msg').innerText = '‚ùå Insufficient balance';
        document.getElementById('withdraw-msg').style.color = '#d03030';
        return;
      }

      // Create withdrawal request
      // Note: This would need a backend endpoint to persist
      const req = {
        amount: amt,
        address: addr,
        network: document.getElementById('withdraw-network').value,
        ts: new Date().toISOString()
      };

      document.getElementById('withdraw-msg').innerText = `‚úÖ Withdrawal request submitted successfully. Amount: $${amt.toFixed(2)}. Your request is now under review and will be processed within 1-3 business days. You'll receive a confirmation email once approved.`;
      document.getElementById('withdraw-msg').style.color = '#0b9d58';
      document.getElementById('withdraw-amt').value = '';
      document.getElementById('wallet-addr').value = '';
      
      renderPage();
    });

    ensureUser().then(() => {
      renderHeader();
      renderPage();
    });
  </script>
</body>
</html>
