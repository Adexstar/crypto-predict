<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Transfer Exchange</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header class="header" id="app-header"></header>
  <main class="container">
    <div class="back-link"><a href="index.html">← Back to Dashboard</a></div>
    
    <div class="card">
      <h2>Internal Fund Transfer</h2>
      <p class="small">Transfer funds between your Spot, Futures, and Options accounts.</p>
      
      <div style="margin-top:20px">
        <div class="account-overview" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;margin-bottom:20px">
          <div class="card" style="padding:12px">
            <div class="small">Spot Account</div>
            <div style="font-weight:700;font-size:16px;margin-top:5px">$<span id="spot-bal">0.00</span></div>
          </div>
          <div class="card" style="padding:12px">
            <div class="small">Futures Account</div>
            <div style="font-weight:700;font-size:16px;margin-top:5px">$<span id="futures-bal">0.00</span></div>
          </div>
          <div class="card" style="padding:12px">
            <div class="small">Options Account</div>
            <div style="font-weight:700;font-size:16px;margin-top:5px">$<span id="options-bal">0.00</span></div>
          </div>
        </div>

        <div class="form-group">
          <label>From Account</label>
          <select id="from-account" class="input">
            <option value="spot">Spot Trading</option>
            <option value="futures">Futures/Margin</option>
            <option value="options">Options</option>
          </select>
        </div>

        <div class="form-group">
          <label>To Account</label>
          <select id="to-account" class="input">
            <option value="futures">Futures/Margin</option>
            <option value="options">Options</option>
            <option value="spot">Spot Trading</option>
          </select>
        </div>

        <div class="form-group">
          <label>Amount to Transfer</label>
          <input type="number" id="transfer-amt" class="input" placeholder="Enter amount">
        </div>

        <button class="cta cta-full" id="transfer-btn">Transfer Now</button>
        <div id="transfer-msg" class="small" style="margin-top:10px;text-align:center"></div>

        <div style="margin-top:30px" class="divider"></div>

        <h3 style="margin-top:20px">Transfer History</h3>
        <div id="transfers-list" style="margin-top:15px"></div>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/lightweight-charts@3.10.0/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="js/api-config.js"></script>
  <script type="module">
    import { getRealUser } from './js/user-context.js';
    let currentUser = null;

    async function ensureUser() {
      currentUser = await getRealUser();
      if (!currentUser) window.location.href = 'login.html';
      else renderPage();
    }

    function renderHeader() {
      if (!currentUser) return;
      document.getElementById('app-header').innerHTML = `
        <div class="brand"><div class="logo">FX</div><div>
          <div style="font-weight:800">Transfer Funds</div>
          <div class="small">User: ${currentUser.name}</div>
        </div></div>
        <div class="nav">
          <span class="badge-sim">TRANSFER NOW</span>
        </div>`;
    }

    async function renderPage() {
      if (!currentUser) return;
      
      // Refresh user data to get latest balances
      try {
        const freshUser = await UserAPI.getProfile();
        currentUser = freshUser.user || freshUser;
      } catch (e) {
        console.warn('Could not refresh user data:', e.message);
      }
      
      const spotBal = currentUser.spotBalance || 0;
      const futuresBal = currentUser.futuresBalance || 0;
      const optionsBal = currentUser.optionsBalance || 0;
      
      document.getElementById('spot-bal').innerText = spotBal.toLocaleString(undefined, {minimumFractionDigits:2});
      document.getElementById('futures-bal').innerText = futuresBal.toLocaleString(undefined, {minimumFractionDigits:2});
      document.getElementById('options-bal').innerText = optionsBal.toLocaleString(undefined, {minimumFractionDigits:2});

      // Load transfers from API
      try {
        const response = await fetch(`${API_CONFIG.API_URL}/transfers`, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
        });
        const data = await response.json();
        
        const list = document.getElementById('transfers-list');
        if (!data.transfers || data.transfers.length === 0) {
          list.innerHTML = '<p class="small">No transfers yet</p>';
        } else {
          list.innerHTML = data.transfers.slice(0, 10).map(t => {
            const meta = typeof t.meta === 'string' ? JSON.parse(t.meta) : t.meta;
            return `
              <div class="card" style="margin-bottom:10px;padding:10px;background:#f0f4ff">
                <div class="kv">
                  <div><strong>$${(meta.amount || 0).toLocaleString(undefined, {minimumFractionDigits:2})}</strong></div>
                  <div class="small">${meta.from || 'unknown'} → ${meta.to || 'unknown'}</div>
                </div>
                <div class="small" style="margin-top:5px">${new Date(t.createdAt).toLocaleString()}</div>
              </div>
            `;
          }).join('');
        }
      } catch (error) {
        console.error('Failed to load transfers:', error);
        document.getElementById('transfers-list').innerHTML = '<p class="small error">Failed to load transfer history</p>';
      }
    }

    document.getElementById('transfer-btn').addEventListener('click', async () => {
      const amt = Number(document.getElementById('transfer-amt').value || 0);
      const from = document.getElementById('from-account').value;
      const to = document.getElementById('to-account').value;
      const msgEl = document.getElementById('transfer-msg');
      
      if (!currentUser) {
        msgEl.innerText = '❌ Not authenticated';
        msgEl.style.color = '#d03030';
        return;
      }
      
      if (from === to) {
        msgEl.innerText = '❌ From and To accounts must be different';
        msgEl.style.color = '#d03030';
        return;
      }

      if (amt <= 0) {
        msgEl.innerText = '❌ Enter a valid amount';
        msgEl.style.color = '#d03030';
        return;
      }

      const sourceBalance = currentUser[`${from}Balance`] || 0;
      if (amt > sourceBalance) {
        msgEl.innerText = `❌ Insufficient ${from} balance`;
        msgEl.style.color = '#d03030';
        return;
      }

      try {
        msgEl.innerText = '⏳ Processing transfer...';
        msgEl.style.color = '#f0ad4e';
        
        const response = await fetch(`${API_CONFIG.API_URL}/transfers`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          },
          body: JSON.stringify({
            fromAccount: from,
            toAccount: to,
            amount: amt
          })
        });

        const data = await response.json();
        
        if (response.ok) {
          msgEl.innerText = `✅ ${data.message}`;
          msgEl.style.color = '#0b9d58';
          document.getElementById('transfer-amt').value = '';
          
          // Update local user data
          currentUser = data.user;
          await renderPage();
        } else {
          msgEl.innerText = `❌ ${data.error}`;
          msgEl.style.color = '#d03030';
        }
      } catch (error) {
        console.error('Transfer error:', error);
        msgEl.innerText = '❌ Transfer failed. Please try again.';
        msgEl.style.color = '#d03030';
      }
    });

    renderHeader();
    ensureUser();
  </script>
</body>
</html>
