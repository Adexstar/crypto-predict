<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign Up - 24h Trading</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .auth-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 440px;
      padding: 50px 40px;
    }

    .logo { text-align: center; font-size: 3.5rem; margin-bottom: 10px; }
    h1 { text-align: center; color: #1a1a2e; font-size: 2rem; margin-bottom: 8px; }
    .subtitle { text-align: center; color: #666; font-size: 0.95rem; margin-bottom: 35px; }

    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; color: #333; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem; }
    .form-group input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s;
      font-family: inherit;
    }
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .form-group input:disabled { opacity: 0.6; cursor: not-allowed; background: #f5f5f5; }
    .form-group small { display: block; color: #999; font-size: 0.85rem; margin-top: 5px; }

    .input-group {
      display: flex;
      gap: 10px;
    }
    .input-group input { flex: 1; }
    .input-group button {
      padding: 14px 24px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
      font-size: 0.9rem;
    }
    .input-group button:hover:not(:disabled) { background: #5568d3; transform: translateY(-1px); }
    .input-group button:disabled { opacity: 0.6; cursor: not-allowed; }

    .btn-primary {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.05rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .message {
      padding: 14px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 0.9rem;
      display: none;
      text-align: center;
    }
    .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

    .divider {
      text-align: center;
      margin: 30px 0;
      color: #999;
      position: relative;
    }
    .divider::before,
    .divider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 40%;
      height: 1px;
      background: #e0e0e0;
    }
    .divider::before { left: 0; }
    .divider::after { right: 0; }

    .switch-link {
      text-align: center;
      margin-top: 25px;
      color: #666;
      font-size: 0.95rem;
    }
    .switch-link a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
    }
    .switch-link a:hover { color: #5568d3; }

    .hidden { display: none !important; }

    @media (max-width: 480px) {
      .auth-container { padding: 40px 30px; }
      h1 { font-size: 1.7rem; }
      .input-group { flex-direction: column; }
      .input-group button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="logo">üìä</div>
    <h1>Create Account</h1>
    <p class="subtitle">Start trading in minutes</p>

    <div class="message" id="message"></div>

    <form id="signup-form">
      <!-- Step 1: Email & Verification -->
      <div class="form-group">
        <label>Email Address</label>
        <div class="input-group">
          <input type="email" id="signup-email" placeholder="your@email.com" required autocomplete="email">
          <button type="button" id="send-code-btn">Send Code</button>
        </div>
      </div>

      <div class="form-group hidden" id="code-group">
        <label>Verification Code</label>
        <input type="text" id="verification-code" placeholder="Enter 6-digit code" maxlength="6" pattern="[0-9]{6}">
        <small>Check your email for the verification code</small>
      </div>

      <!-- Step 2: Account Details (shown after code verified) -->
      <div id="details-section" class="hidden">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="signup-name" placeholder="John Doe" required autocomplete="name">
        </div>

        <div class="form-group">
          <label>Password</label>
          <input type="password" id="signup-password" placeholder="At least 6 characters" required autocomplete="new-password">
        </div>

        <div class="form-group">
          <label>Confirm Password</label>
          <input type="password" id="signup-confirm" placeholder="Re-enter password" required autocomplete="new-password">
        </div>
      </div>

      <button type="submit" class="btn-primary" id="signup-btn">Create Account</button>
    </form>

    <div class="divider">or</div>

    <div class="switch-link">
      Already have an account? <a href="login.html">Sign In</a>
    </div>
  </div>

  <script src="/js/api-config.js"></script>
  <script>
    const messageDiv = document.getElementById('message');
    const sendCodeBtn = document.getElementById('send-code-btn');
    const signupBtn = document.getElementById('signup-btn');
    const emailInput = document.getElementById('signup-email');
    const codeInput = document.getElementById('verification-code');
    const codeGroup = document.getElementById('code-group');
    const detailsSection = document.getElementById('details-section');

    let codeSent = false;
    let codeVerified = false;
    let userEmail = '';

    function showMessage(text, type = 'info') {
      messageDiv.textContent = text;
      messageDiv.className = `message ${type}`;
      messageDiv.style.display = 'block';
    }

    function hideMessage() {
      messageDiv.style.display = 'none';
    }

    // Send verification code
    sendCodeBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      
      if (!email || !email.includes('@')) {
        showMessage('Please enter a valid email address', 'error');
        return;
      }

      userEmail = email;
      sendCodeBtn.disabled = true;
      sendCodeBtn.textContent = 'Sending...';
      hideMessage();

      try {
        await API.post('/auth/send-verification-code', { email });
        showMessage('‚úÖ Verification code sent! Check your email.', 'success');
        codeSent = true;
        emailInput.disabled = true;
        codeGroup.classList.remove('hidden');
        codeInput.focus();
        
        // Cooldown
        let seconds = 60;
        sendCodeBtn.textContent = `Resend (${seconds}s)`;
        const interval = setInterval(() => {
          seconds--;
          if (seconds > 0) {
            sendCodeBtn.textContent = `Resend (${seconds}s)`;
          } else {
            clearInterval(interval);
            sendCodeBtn.disabled = false;
            sendCodeBtn.textContent = 'Resend Code';
          }
        }, 1000);
      } catch (error) {
        showMessage('‚ùå ' + (error.message || 'Failed to send code'), 'error');
        sendCodeBtn.disabled = false;
        sendCodeBtn.textContent = 'Send Code';
      }
    });

    // Auto-verify code when 6 digits entered
    codeInput.addEventListener('input', async (e) => {
      const code = e.target.value.trim();
      
      if (code.length === 6 && !codeVerified) {
        hideMessage();
        codeInput.disabled = true;
        
        try {
          await API.post('/auth/verify-code', { email: userEmail, code });
          showMessage('‚úÖ Code verified! Complete your registration below.', 'success');
          codeVerified = true;
          detailsSection.classList.remove('hidden');
          document.getElementById('signup-name').focus();
          signupBtn.textContent = 'Create Account & Sign In';
        } catch (error) {
          showMessage('‚ùå Invalid code. Please try again.', 'error');
          codeInput.disabled = false;
          codeInput.value = '';
          codeInput.focus();
        }
      }
    });

    // Final signup
    document.getElementById('signup-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      hideMessage();

      if (!codeVerified) {
        showMessage('Please verify your email first', 'error');
        return;
      }

      const name = document.getElementById('signup-name').value.trim();
      const password = document.getElementById('signup-password').value;
      const confirm = document.getElementById('signup-confirm').value;
      const code = codeInput.value.trim();

      if (!name) {
        showMessage('Please enter your full name', 'error');
        return;
      }

      if (password.length < 6) {
        showMessage('Password must be at least 6 characters', 'error');
        return;
      }

      if (password !== confirm) {
        showMessage('Passwords do not match', 'error');
        return;
      }

      signupBtn.disabled = true;
      signupBtn.textContent = 'Creating Account...';

      try {
        const response = await API.post('/auth/register', {
          email: userEmail,
          code,
          name,
          password
        });

        if (response.token) {
          localStorage.setItem('authToken', response.token);
          showMessage('‚úÖ Account created! Redirecting to dashboard...', 'success');
          setTimeout(() => window.location.href = '/index.html', 1500);
        }
      } catch (error) {
        showMessage('‚ùå ' + (error.message || 'Registration failed'), 'error');
        signupBtn.disabled = false;
        signupBtn.textContent = 'Create Account & Sign In';
      }
    });
  </script>
</body>
</html>
