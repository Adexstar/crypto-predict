<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - 24h Trading</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .auth-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 440px;
      padding: 50px 40px;
    }

    .logo { text-align: center; font-size: 3.5rem; margin-bottom: 10px; }
    h1 { text-align: center; color: #1a1a2e; font-size: 2rem; margin-bottom: 8px; }
    .subtitle { text-align: center; color: #666; font-size: 0.95rem; margin-bottom: 35px; }

    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; color: #333; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem; }
    .form-group input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s;
      font-family: inherit;
    }
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .input-group {
      display: flex;
      gap: 10px;
    }
    .input-group input { flex: 1; }
    .input-group button {
      padding: 14px 24px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
      font-size: 0.9rem;
    }
    .input-group button:hover:not(:disabled) { background: #5568d3; transform: translateY(-1px); }
    .input-group button:disabled { opacity: 0.6; cursor: not-allowed; }

    .btn-primary {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.05rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .message {
      padding: 14px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 0.9rem;
      display: none;
      text-align: center;
    }
    .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

    .links {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
      font-size: 0.9rem;
    }
    .links a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
      transition: color 0.3s;
    }
    .links a:hover { color: #5568d3; }

    .divider {
      text-align: center;
      margin: 30px 0;
      color: #999;
      position: relative;
    }
    .divider::before,
    .divider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 40%;
      height: 1px;
      background: #e0e0e0;
    }
    .divider::before { left: 0; }
    .divider::after { right: 0; }

    .switch-link {
      text-align: center;
      margin-top: 25px;
      color: #666;
      font-size: 0.95rem;
    }
    .switch-link a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
    }
    .switch-link a:hover { color: #5568d3; }

    .hidden { display: none; }

    @media (max-width: 480px) {
      .auth-container { padding: 40px 30px; }
      h1 { font-size: 1.7rem; }
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="logo">üìä</div>
    <h1 id="page-title">Welcome Back</h1>
    <p class="subtitle" id="page-subtitle">Sign in to continue trading</p>

    <div class="message" id="message"></div>

    <!-- LOGIN FORM -->
    <form id="login-form">
      <div class="form-group">
        <label>Email Address</label>
        <input type="email" id="login-email" placeholder="your@email.com" required autocomplete="email">
      </div>

      <div class="form-group">
        <label>Password</label>
        <input type="password" id="login-password" placeholder="Enter your password" required autocomplete="current-password">
      </div>

      <div class="links">
        <a id="show-forgot">Forgot Password?</a>
      </div>

      <button type="submit" class="btn-primary" id="login-btn">Sign In</button>
    </form>

    <!-- FORGOT PASSWORD FORM -->
    <form id="forgot-form" class="hidden">
      <div class="form-group">
        <label>Email Address</label>
        <div class="input-group">
          <input type="email" id="forgot-email" placeholder="your@email.com" required>
          <button type="button" id="send-reset-btn">Send Code</button>
        </div>
      </div>

      <div class="form-group hidden" id="reset-code-group">
        <label>Reset Code</label>
        <input type="text" id="reset-code" placeholder="Enter 6-digit code" maxlength="6" pattern="[0-9]{6}">
      </div>

      <div class="form-group hidden" id="new-password-group">
        <label>New Password</label>
        <input type="password" id="new-password" placeholder="Enter new password" minlength="6">
      </div>

      <div class="form-group hidden" id="confirm-password-group">
        <label>Confirm Password</label>
        <input type="password" id="confirm-password" placeholder="Confirm new password">
      </div>

      <button type="submit" class="btn-primary hidden" id="reset-btn">Reset Password</button>
      
      <div class="links">
        <a id="back-to-login">‚Üê Back to Login</a>
      </div>
    </form>

    <div class="divider">or</div>

    <div class="switch-link">
      Don't have an account? <a href="signup.html">Create Account</a>
    </div>
  </div>

  <script src="/js/api-config.js"></script>
  <script>
    const loginForm = document.getElementById('login-form');
    const forgotForm = document.getElementById('forgot-form');
    const messageDiv = document.getElementById('message');
    const pageTitle = document.getElementById('page-title');
    const pageSubtitle = document.getElementById('page-subtitle');

    // Show/hide functions
    function showMessage(text, type = 'info') {
      messageDiv.textContent = text;
      messageDiv.className = `message ${type}`;
      messageDiv.style.display = 'block';
    }

    function hideMessage() {
      messageDiv.style.display = 'none';
    }

    // Switch to forgot password
    document.getElementById('show-forgot').addEventListener('click', (e) => {
      e.preventDefault();
      loginForm.classList.add('hidden');
      forgotForm.classList.remove('hidden');
      pageTitle.textContent = 'Reset Password';
      pageSubtitle.textContent = 'Enter your email to receive a reset code';
      hideMessage();
    });

    // Back to login
    document.getElementById('back-to-login').addEventListener('click', (e) => {
      e.preventDefault();
      forgotForm.classList.add('hidden');
      loginForm.classList.remove('hidden');
      pageTitle.textContent = 'Welcome Back';
      pageSubtitle.textContent = 'Sign in to continue trading';
      document.getElementById('reset-code-group').classList.add('hidden');
      document.getElementById('new-password-group').classList.add('hidden');
      document.getElementById('confirm-password-group').classList.add('hidden');
      document.getElementById('reset-btn').classList.add('hidden');
      hideMessage();
    });

    // LOGIN
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideMessage();

      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;

      if (!email || !password) {
        showMessage('Please enter both email and password', 'error');
        return;
      }

      const loginBtn = document.getElementById('login-btn');
      loginBtn.disabled = true;
      loginBtn.textContent = 'Signing in...';

      try {
        const response = await API.post('/auth/login', { email, password });
        
        if (response.requiresVerification) {
          showMessage('Please verify your email first. Check your inbox for the verification code.', 'error');
          setTimeout(() => window.location.href = 'signup.html', 2000);
          return;
        }

        if (response.token) {
          localStorage.setItem('authToken', response.token);
          showMessage('Login successful! Redirecting...', 'success');
          setTimeout(() => window.location.href = '/index.html', 1500);
        }
      } catch (error) {
        showMessage(error.message || 'Login failed. Please check your credentials.', 'error');
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign In';
      }
    });

    // SEND RESET CODE
    document.getElementById('send-reset-btn').addEventListener('click', async () => {
      const email = document.getElementById('forgot-email').value.trim();
      
      if (!email || !email.includes('@')) {
        showMessage('Please enter a valid email address', 'error');
        return;
      }

      const sendBtn = document.getElementById('send-reset-btn');
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';
      hideMessage();

      try {
        await API.post('/auth/forgot-password', { email });
        showMessage('Reset code sent! Check your email.', 'success');
        document.getElementById('forgot-email').disabled = true;
        document.getElementById('reset-code-group').classList.remove('hidden');
        document.getElementById('new-password-group').classList.remove('hidden');
        document.getElementById('confirm-password-group').classList.remove('hidden');
        document.getElementById('reset-btn').classList.remove('hidden');
        
        // Cooldown
        let seconds = 60;
        const interval = setInterval(() => {
          seconds--;
          if (seconds > 0) {
            sendBtn.textContent = `Resend (${seconds}s)`;
          } else {
            clearInterval(interval);
            sendBtn.disabled = false;
            sendBtn.textContent = 'Resend Code';
          }
        }, 1000);
      } catch (error) {
        showMessage(error.message || 'Failed to send reset code', 'error');
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send Code';
      }
    });

    // RESET PASSWORD
    document.getElementById('forgot-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      hideMessage();

      const email = document.getElementById('forgot-email').value.trim();
      const code = document.getElementById('reset-code').value.trim();
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      if (code.length !== 6) {
        showMessage('Please enter the 6-digit code', 'error');
        return;
      }

      if (newPassword.length < 6) {
        showMessage('Password must be at least 6 characters', 'error');
        return;
      }

      if (newPassword !== confirmPassword) {
        showMessage('Passwords do not match', 'error');
        return;
      }

      const resetBtn = document.getElementById('reset-btn');
      resetBtn.disabled = true;
      resetBtn.textContent = 'Resetting...';

      try {
        await API.post('/auth/reset-password', { email, code, newPassword });
        showMessage('Password reset successful! Redirecting to login...', 'success');
        
        setTimeout(() => {
          document.getElementById('back-to-login').click();
          document.getElementById('login-email').value = email;
        }, 2000);
      } catch (error) {
        showMessage(error.message || 'Failed to reset password', 'error');
        resetBtn.disabled = false;
        resetBtn.textContent = 'Reset Password';
      }
    });
  </script>
</body>
</html>
