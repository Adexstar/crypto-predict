<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deposit Trading Account</title>
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header class="header" id="app-header"></header>
  <main class="container">
    <div class="back-link"><a href="index.html">‚Üê Back to Dashboard</a></div>
    
    <div class="qa-indicator" style="margin-bottom:20px">üî¨ Deposit Feed</div>
    
    <div class="card">
      <h2 class="card-title">Add Funds to Account</h2>
      <p class="card-subtitle">Account Balance Adjustment</p>
      
      <div style="margin-top:20px">
        <div class="form-group">
          <label>Select Network</label>
          <select id="network" class="input">
            <option value="eth">ETH (Ethereum)</option>
            <option value="btc">BTC (Bitcoin)</option>
            <option value="solana">Solana</option>
            <option value="trc20">TRC-20 (Tron)</option>
          </select>
        </div>

        <div class="form-group">
          <label>Selected Asset</label>
          <div id="asset-display" style="padding:12px;background:#f5f5f5;border-radius:8px;font-weight:600;color:#333">
            ETH - Ethereum Network
          </div>
        </div>

        <div class="deposit-box" style="margin-top:20px;padding:20px;background:#f5f5f5;border-radius:8px;text-align:center">
          <div style="font-size:13px;color:#666;margin-bottom:10px">QR Code</div>
          <div id="qr-placeholder" style="width:200px;height:200px;margin:0 auto;background:#ddd;display:flex;align-items:center;justify-content:center;border-radius:8px">
            <div class="small">‚ñà ‚ñà ‚ñà QR ‚ñà ‚ñà ‚ñà<br/>‚ñà SIM ‚ñà ‚ñà ‚ñà<br/>‚ñà ‚ñà ‚ñà ‚ñà ‚ñà ‚ñà</div>
          </div>
        </div>

        <div style="margin-top:20px" class="address-box">
          <label>Wallet Address</label>
          <div style="background:#565252;padding:10px;border-radius:8px;word-break:break-all;font-family:monospace;font-size:12px">
            0xB443B078d4b5fe5fb304bE9AEEe2B0B1Db0a02F302700Af88EC
          </div>
          <button class="cta" style="margin-top:10px;width:100%" onclick="copyAddress()">Copy Address</button>
        </div>

        <div style="margin-top:20px" class="warning-box">
          <strong>‚ö†Ô∏è IMPORTANT</strong>
          <p class="small">Verify real crypto wallets or addresses before sending.</p>
        </div>

        <div class="form-group" style="margin-top:20px">
          <label>Deposit Amount (USD Equivalent)</label>
          <input type="number" id="deposit-amt" class="input" placeholder="Enter amount" min="10">
          <div class="small" style="margin-top:8px;color:#f59e0b">‚ö†Ô∏è Send exact amount in crypto to the address above to avoid verification delays</div>
          <button class="cta cta-full" style="margin-top:15px" id="submit-deposit-btn">SUBMIT DEPOSIT ORDER</button>
          <div id="deposit-msg" class="small" style="margin-top:10px;text-align:center"></div>
        </div>

        <div style="margin-top:30px" class="divider"></div>

        <h3 style="margin-top:20px">Deposit Status & History</h3>
        <div id="deposits-history" style="margin-top:15px"></div>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/lightweight-charts@3.10.0/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="js/api-config.js"></script>
  <script type="module">
    import { getRealUser } from './js/user-context.js';

    let currentUser = null;
    let currentWalletAddress = '';

    // Network configuration with primary asset, wallet addresses, and QR codes
    const networkConfig = {
      eth: {
        name: 'ETH (Ethereum)',
        asset: { value: 'eth', label: 'ETH - Ethereum Network', address: '0x44e71846a7886122697620a8748283e04363d7b1' },
        qrCode: { image: 'images/qr/eth-qr.png', color: '#627EEA', label: 'ETH QR Code' }
      },
      btc: {
        name: 'BTC (Bitcoin)',
        asset: { value: 'btc', label: 'BTC - Bitcoin Network', address: 'bc1q6nlk3xt4hz8zkyavs8g89kxfqspj3yjk4n6yn6' },
        qrCode: { image: 'images/qr/btc-qr.png', color: '#F7931A', label: 'BTC QR Code' }
      },
      solana: {
        name: 'Solana',
        asset: { value: 'sol', label: 'SOL - Solana Network', address: '7bnAdcn365Vi1L1FmGMQhy3pkD44VG5fHE4ywzb4Bp1Z' },
        qrCode: { image: 'images/qr/sol-qr.png', color: '#14F195', label: 'Solana QR Code' }
      },
      trc20: {
        name: 'Tether(USDT TRC20)',
        asset: { value: 'trc', label: 'TRC - Tron Network', address: 'TYc8y2ts17WEv3oHRgkuWW6QDTLnPjZYMB' },
        qrCode: { image: 'images/qr/trc20-qr.png', color: '#EB0029', label: 'TRC-20 QR Code' }
      }
    };

    function renderHeader() {
      if (!currentUser) return;
      document.getElementById('app-header').innerHTML = `
        <div class="brand"><div class="logo">FX</div><div>
          <div style="font-weight:800">Deposit</div>
          <div class="small">User: ${currentUser.name}</div>
        </div></div>
        <div class="nav">
          <span class="badge-sim">MAKE DEPOSIT</span>
        </div>`;
    }

    function updateNetworkData() {
      const networkSelect = document.getElementById('network');
      const selectedNetwork = networkSelect.value;
      const config = networkConfig[selectedNetwork];

      if (!config) {
        console.error('Network config not found for:', selectedNetwork);
        return;
      }

      console.log('Updating network to:', selectedNetwork, 'Config:', config);

      // Update asset display
      const assetDisplay = document.getElementById('asset-display');
      if (assetDisplay) {
        assetDisplay.textContent = config.asset.label;
      }
      
      // Update wallet address
      currentWalletAddress = config.asset.address;
      const addressBox = document.querySelector('.address-box div');
      if (addressBox) {
        addressBox.textContent = config.asset.address;
      }
      
      // Update QR Code 
      const qrPlaceholder = document.getElementById('qr-placeholder');
      if (qrPlaceholder) {
        const qrData = config.qrCode;
        const imagePath = qrData.image;
        console.log('Loading QR from:', imagePath);
        qrPlaceholder.innerHTML = `
          <img 
            src="${imagePath}" 
            alt="${qrData.label}" 
            style="width:100%;height:100%;border-radius:8px;object-fit:contain;background:#f5f5f5;padding:5px"
            onload="console.log('QR loaded successfully')"
            onerror="console.error('QR failed to load from ${imagePath}');this.parentElement.innerHTML='<div style=\'width:200px;height:200px;background:#f5f5f5;border:2px dashed #ccc;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#999\\'><div style=\\'font-size:40px;margin-bottom:10px\\'>üì∑</div><div style=\\'font-size:11px;text-align:center\\'>QR: ${qrData.label}</div></div>'"
          />
        `;
      }
    }

    async function loadDeposits() {
      try {
        const deposits = await DepositAPI.getMyDeposits();
        renderDeposits(deposits);
      } catch (error) {
        console.error('Error loading deposits:', error);
      }
    }

    function renderDeposits(deposits) {
      if (!currentUser) return;
      
      const list = document.getElementById('deposits-history');
      
      if (!deposits || deposits.length === 0) {
        list.innerHTML = '<p class="small">No deposits yet</p>';
        return;
      }

      list.innerHTML = deposits.map(d => {
        const statusColor = d.status === 'PENDING' ? '#f59e0b' : d.status === 'CONFIRMED' ? '#0b9d58' : '#d03030';
        const statusLabel = d.status === 'PENDING' ? '‚è≥ PENDING CONFIRMATION' : d.status === 'CONFIRMED' ? '‚úÖ CONFIRMED' : '‚ùå REJECTED';
        
        return `
          <div class="card" style="margin-bottom:10px;padding:12px;border-left:4px solid ${statusColor}">
            <div class="kv">
              <div>
                <div style="font-weight:700">$${d.amount.toLocaleString()}</div>
                <div class="small">${(d.asset || 'UNKNOWN').toUpperCase()} on ${(d.network || 'UNKNOWN').toUpperCase()}</div>
              </div>
              <div style="text-align:right">
                <div class="small" style="color:${statusColor};font-weight:700">${statusLabel}</div>
                <div class="small">${new Date(d.createdAt).toLocaleString()}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    window.copyAddress = function() {
      navigator.clipboard.writeText(currentWalletAddress).then(() => {
        alert('Address copied: ' + currentWalletAddress);
      }).catch(err => {
        console.error('Failed to copy:', err);
      });
    };

    // Initialize
    (async () => {
      try {
        // Check auth
        await AuthAPI.verify();
        
        // Get user
        currentUser = await getRealUser();
        if (!currentUser) {
          window.location.href = 'login.html';
          return;
        }

        renderHeader();
        
        // Set up network change listener
        const networkSelect = document.getElementById('network');
        if (networkSelect) {
          networkSelect.addEventListener('change', updateNetworkData);
        }
        
        // Initialize network data
        updateNetworkData();
        
        // Load deposits
        await loadDeposits();
        
        // Submit deposit
        document.getElementById('submit-deposit-btn').addEventListener('click', async () => {
          const amt = Number(document.getElementById('deposit-amt').value || 0);
          const network = document.getElementById('network').value;
          const asset = networkConfig[network].asset.value;
          
          if (amt <= 0) {
            document.getElementById('deposit-msg').innerText = '‚ùå Enter a valid amount';
            document.getElementById('deposit-msg').style.color = '#d03030';
            return;
          }

          if (amt < 10) {
            document.getElementById('deposit-msg').innerText = '‚ùå Minimum deposit is $10';
            document.getElementById('deposit-msg').style.color = '#d03030';
            return;
          }

          try {
            document.getElementById('submit-deposit-btn').disabled = true;
            document.getElementById('submit-deposit-btn').innerText = 'Submitting...';
            
            const result = await DepositAPI.submit({
              amount: amt,
              network: network,
              asset: asset,
              walletAddress: currentWalletAddress
            });

            document.getElementById('deposit-msg').innerText = `‚úÖ Deposit submitted! Amount: $${amt.toFixed(2)}`;
            document.getElementById('deposit-msg').style.color = '#0b9d58';
            document.getElementById('deposit-amt').value = '';
            
            // Reload deposits
            await loadDeposits();
            
            setTimeout(() => {
              document.getElementById('submit-deposit-btn').disabled = false;
              document.getElementById('submit-deposit-btn').innerText = 'SUBMIT DEPOSIT ORDER';
            }, 2000);
          } catch (error) {
            console.error('Deposit error:', error);
            document.getElementById('deposit-msg').innerText = '‚ùå ' + (error.message || 'Failed to submit deposit');
            document.getElementById('deposit-msg').style.color = '#d03030';
            document.getElementById('submit-deposit-btn').disabled = false;
            document.getElementById('submit-deposit-btn').innerText = 'SUBMIT DEPOSIT ORDER';
          }
        });
      } catch (error) {
        console.error('Auth error:', error);
        window.location.href = 'login.html';
      }
    })();
  </script>
</body>
</html>
