<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Trading ‚Äî Dashboard</title>
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header class="header" id="app-header"></header>
  <main id="app-main"></main>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="js/api-config.js"></script>
  <script>
    // Create fallback UI (don't replace body, just show in main)
    function showLoadingUI() {
      const main = document.getElementById('app-main');
      if (main) {
        main.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: #1a1a2e; color: white;">
            <div style="text-align: center;">
              <div style="font-size: 3rem; margin-bottom: 20px;">‚öôÔ∏è</div>
              <h1>Loading Dashboard...</h1>
              <p style="color: #aaa; margin-top: 10px;">Initializing your trading platform</p>
            </div>
          </div>
        `;
      }
    }

    function showErrorUI(message, details) {
      const main = document.getElementById('app-main');
      if (main) {
        main.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: #1a1a2e; color: white;">
            <div style="text-align: center; max-width: 500px; padding: 40px;">
              <div style="font-size: 3rem; margin-bottom: 20px;">‚ùå</div>
              <h1>Dashboard Error</h1>
              <p style="color: #ff6b6b; margin-top: 10px; word-break: break-word;">${message}</p>
              <details style="margin-top: 20px; text-align: left; background: rgba(255,107,107,0.1); padding: 15px; border-radius: 8px;">
                <summary style="cursor: pointer; color: #ff6b6b;">Technical Details</summary>
                <pre style="margin-top: 10px; overflow-x: auto; font-size: 0.8rem; color: #aaa;">${details}</pre>
              </details>
              <button onclick="location.reload()" style="margin-top: 20px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;">Retry</button>
              <button onclick="window.location.href='/login.html'" style="margin-top: 10px; margin-left: 10px; padding: 12px 24px; background: #444; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;">Back to Login</button>
            </div>
          </div>
        `;
      }
    }

    // Show loading UI immediately
    showLoadingUI();

    // Check authentication before loading dashboard
    (async () => {
      try {
        console.log('üîê Verifying authentication...');
        const response = await AuthAPI.verify();
        const userData = response.user || response;
        console.log('‚úÖ Auth verified:', userData);
        
        if (!userData || !userData.id) {
          console.log('‚ùå No user data found, redirecting to login');
          window.location.href = 'login.html';
          return;
        }

        // User is authenticated, load dashboard module
        try {
          console.log('üì¶ Loading dashboard module...');
          const dashboardModule = await import('./js/dashboard.js');
          console.log('‚úÖ Dashboard loaded successfully');
          
          // Call mount function to render the dashboard
          if (typeof window.mount === 'function') {
            console.log('üé® Rendering dashboard UI...');
            window.mount();
            // Start refresh engine
            if (window.dashboardRefresh) {
              window.dashboardRefresh.start();
            }
            // Initial widget update
            if (typeof window.updateAllWidgets === 'function') {
              window.updateAllWidgets();
            }
            console.log('‚úÖ Dashboard rendered successfully');
          } else {
            showErrorUI(
              'Dashboard mount function not found',
              'The mount() function was not exported properly from dashboard.js'
            );
          }
        } catch (dashboardError) {
          console.error('‚ùå Failed to load dashboard:', dashboardError);
          showErrorUI(
            'Failed to load dashboard module',
            dashboardError.message + '\n\n' + dashboardError.stack
          );
        }
      } catch (error) {
        console.error('üî¥ Auth check failed:', error);
        showErrorUI(
          'Authentication failed: ' + error.message,
          error.stack
        );
      }
    })();
  </script>
</body>
</html>