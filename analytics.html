<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Investment Platform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%); color: #fff; min-height: 100vh; }
        
        .navbar { background: rgba(26, 26, 46, 0.95); border-bottom: 1px solid #3861fb; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .navbar h1 { font-size: 1.5rem; color: #f0ad4e; }
        .navbar-links { display: flex; gap: 20px; align-items: center; }
        .navbar-links a { color: #f0ad4e; text-decoration: none; font-size: 0.95rem; transition: color 0.3s; }
        .navbar-links a:hover { color: #fff; }
        .logout-btn { background: #f6465d; color: #fff; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; transition: background 0.3s; }
        .logout-btn:hover { background: #e63547; }
        
        .container { max-width: 1200px; margin: 30px auto; padding: 20px; }
        
        .page-header { margin-bottom: 30px; }
        .page-header h2 { color: #f0ad4e; font-size: 2rem; margin-bottom: 10px; }
        .page-header p { color: #aaa; font-size: 0.95rem; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        
        .stat-card { 
            background: linear-gradient(135deg, rgba(56, 97, 251, 0.1), rgba(240, 173, 78, 0.05));
            border: 1px solid #3861fb;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .stat-label { color: #a1a1a9; font-size: 0.85rem; margin-bottom: 10px; }
        .stat-value { color: #f0ad4e; font-size: 1.8rem; font-weight: 700; }
        .stat-subtext { color: #6b7280; font-size: 0.8rem; margin-top: 5px; }
        
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        
        .chart-card { 
            background: rgba(26, 26, 46, 0.8);
            border: 1px solid #3861fb;
            border-radius: 8px;
            padding: 20px;
        }
        .chart-title { color: #f0ad4e; font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; }
        
        .activity-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(26, 26, 46, 0.8);
            border: 1px solid #3861fb;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }
        .activity-table th {
            background: rgba(56, 97, 251, 0.2);
            color: #f0ad4e;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #3861fb;
        }
        .activity-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }
        .activity-table tr:hover {
            background: rgba(56, 97, 251, 0.05);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-deposit { background: rgba(5, 178, 108, 0.2); color: #05b26c; }
        .badge-withdraw { background: rgba(246, 70, 93, 0.2); color: #f6465d; }
        .badge-profit { background: rgba(240, 173, 78, 0.2); color: #f0ad4e; }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3861fb, #f0ad4e);
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        @media (max-width: 768px) {
            .container { padding: 15px; margin: 20px auto; }
            .page-header h2 { font-size: 1.5rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-grid { grid-template-columns: 1fr; }
            .activity-table { font-size: 0.9rem; }
            .activity-table th, .activity-table td { padding: 8px; }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>üìä Analytics</h1>
        <div class="navbar-links">
            <a href="landing.html">‚Üê Landing</a>
            <a href="index.html">Dashboard</a>
            <a href="profile.html">Profile</a>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <h2>Your Trading Analytics</h2>
            <p>Comprehensive overview of your account performance and activity</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Deposited</div>
                <div class="stat-value" id="stat-deposited">$0.00</div>
                <div class="stat-subtext">Lifetime deposits</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Current Balance</div>
                <div class="stat-value" id="stat-balance">$0.00</div>
                <div class="stat-subtext">Available funds</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Profit</div>
                <div class="stat-value" id="stat-profit">$0.00</div>
                <div class="stat-subtext" id="stat-profit-pct">+0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Account Age</div>
                <div class="stat-value" id="stat-age">0</div>
                <div class="stat-subtext">Days active</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Withdrawals</div>
                <div class="stat-value" id="stat-withdrawn">$0.00</div>
                <div class="stat-subtext">Funds withdrawn</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Net Gain/Loss</div>
                <div class="stat-value" id="stat-netgain">$0.00</div>
                <div class="stat-subtext">Overall return</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title">Portfolio Breakdown</div>
                <div style="margin: 20px 0;">
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Deposited</span>
                            <span id="chart-dep-pct">0%</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill" id="chart-dep" style="width: 0%;" style="background: #05b26c;"></div></div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Profit Earned</span>
                            <span id="chart-profit-pct">0%</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill" id="chart-profit" style="width: 0%; background: #f0ad4e;"></div></div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Withdrawn</span>
                            <span id="chart-with-pct">0%</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill" id="chart-with" style="width: 0%; background: #f6465d;"></div></div>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Key Metrics</div>
                <div style="margin-top: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="color: #a1a1a9; font-size: 0.85rem; margin-bottom: 5px;">Total Trades</div>
                            <div style="color: #f0ad4e; font-size: 1.5rem; font-weight: 700;" id="metric-trades">0</div>
                        </div>
                        <div>
                            <div style="color: #a1a1a9; font-size: 0.85rem; margin-bottom: 5px;">Profit Margin</div>
                            <div style="color: #f0ad4e; font-size: 1.5rem; font-weight: 700;" id="metric-margin">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <h3 style="color: #f0ad4e; margin: 30px 0 15px 0;">Recent Activity</h3>
        <table class="activity-table">
            <thead>
                <tr>
                    <th>Date & Time</th>
                    <th>Action</th>
                    <th>Amount</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody id="activity-tbody">
                <tr><td colspan="4" style="text-align: center; padding: 20px; color: #a1a1a9;">Loading activity...</td></tr>
            </tbody>
        </table>
    </div>

    <script src="js/api-config.js"></script>
    <script type="module">
        import { getCurrentUser, getUserAnalytics, getUserActivityTimeline } from './js/userData.js';

        function logout() {
            AuthAPI.logout();
        }

        function renderAnalytics() {
            const user = getCurrentUser();
            if (!user) {
                window.location.href = 'landing.html';
                return;
            }

            const analytics = getUserAnalytics(user.id);
            const timeline = getUserActivityTimeline(user.id, 20);

            // Populate stats
            document.getElementById('stat-deposited').textContent = '$' + analytics.totalDeposited.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('stat-balance').textContent = '$' + analytics.currentBalance.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('stat-profit').textContent = '$' + analytics.totalProfit.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('stat-profit-pct').textContent = analytics.profitMargin + '%';
            document.getElementById('stat-age').textContent = analytics.accountAge + ' days';
            document.getElementById('stat-withdrawn').textContent = '$' + analytics.totalWithdrawn.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('stat-netgain').textContent = '$' + analytics.netGain.toLocaleString(undefined, {minimumFractionDigits: 2});

            // Portfolio breakdown
            const total = analytics.totalDeposited + analytics.totalProfit;
            if (total > 0) {
                const depPct = (analytics.totalDeposited / total * 100).toFixed(1);
                const profitPct = (analytics.totalProfit / total * 100).toFixed(1);
                const withPct = (analytics.totalWithdrawn / total * 100).toFixed(1);
                
                document.getElementById('chart-dep').style.width = depPct + '%';
                document.getElementById('chart-dep-pct').textContent = depPct + '%';
                document.getElementById('chart-profit').style.width = profitPct + '%';
                document.getElementById('chart-profit-pct').textContent = profitPct + '%';
                document.getElementById('chart-with').style.width = Math.min(withPct, 100) + '%';
                document.getElementById('chart-with-pct').textContent = withPct + '%';
            }

            // Key metrics
            document.getElementById('metric-trades').textContent = analytics.trades;
            document.getElementById('metric-margin').textContent = analytics.profitMargin + '%';

            // Activity timeline
            const tbody = document.getElementById('activity-tbody');
            if (timeline.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #a1a1a9;">No activity yet</td></tr>';
            } else {
                tbody.innerHTML = timeline.map(entry => {
                    let badgeClass = 'badge-profit';
                    if (entry.action.includes('Deposit')) badgeClass = 'badge-deposit';
                    if (entry.action.includes('Withdrawal')) badgeClass = 'badge-withdraw';
                    
                    return `
                        <tr>
                            <td>${entry.timestamp.toLocaleString()}</td>
                            <td><span class="badge ${badgeClass}">${entry.action}</span></td>
                            <td style="color: #f0ad4e; font-weight: 600;">$${entry.amount.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                            <td style="color: #a1a1a9; font-size: 0.9rem;">${JSON.stringify(entry.meta)}</td>
                        </tr>
                    `;
                }).join('');
            }
        }

        renderAnalytics();
        window.logout = logout;
        
        // Check authentication
        (async () => {
            try {
                await AuthAPI.verify();
            } catch (error) {
                console.warn('Not authenticated, redirecting to login');
                setTimeout(() => window.location.href = 'login.html', 2000);
            }
        })();
    </script>
</body>
</html>
